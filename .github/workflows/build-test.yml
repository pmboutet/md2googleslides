name: Build and Test

on:
  push:
    branches: [ main, feature/* ]
  pull_request:
    branches: [ main ]

jobs:
  validate-lockfile:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Validate package-lock.json
      run: |
        if ! npm ci --ignore-scripts; then
          echo "❌ package-lock.json is out of sync"
          echo "💡 Run 'npm install' to regenerate it"
          exit 1
        fi
        echo "✅ package-lock.json is valid"

  build-test:
    needs: validate-lockfile
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: npm ci --ignore-scripts
      
    - name: Compile TypeScript
      run: npm run compile
      
    - name: Validate server.js
      run: node -c server.js
      
    - name: Run tests
      run: npm test || echo "Tests skipped"

  docker-build:
    needs: validate-lockfile
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -t md2slides-test .
        
    - name: Test Docker container
      run: |
        # Start container in background
        docker run -d --name md2slides-test -p 3000:3000 md2slides-test
        
        # Wait for startup
        sleep 30
        
        # Test health endpoint
        curl -f http://localhost:3000/health
        
        # Cleanup
        docker stop md2slides-test
        docker rm md2slides-test